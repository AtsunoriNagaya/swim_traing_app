# 水泳部向け練習メニュー作成アプリケーション テスト計画書

## テスト対象システム概要
水泳部のコーチや選手が効率的に練習メニューを作成するためのWebアプリケーション。
生成AIを活用し、過去のメニューデータを参照しながら、負荷や時間指定に基づいた最適な練習メニューの自動生成を実現する。

## テスト範囲
### 1. メニュー生成機能テスト
#### 1.1 AI活用メニュー生成
- テストケース:
  - 各AIモデル（OpenAI, Google, Anthropic）での生成
  - APIキーバリデーション
  - エラー時の適切なメッセージ表示

#### 1.2 カスタマイズ機能
- テストケース:
  - 負荷レベル選択の動作確認
  - 練習時間指定の有効性確認
  - 特記事項の反映確認

### 2. データ管理機能テスト
#### 2.1 過去メニューの活用
- テストケース:
  - PDF/CSVアップロードの動作確認
  - ファイルフォーマットのバリデーション
  - 類似メニュー検索の精度確認
  - メニュー履歴の保存と表示確認

#### 2.2 出力機能
- テストケース:
  - PDF出力の正確性確認
  - CSVエクスポートの正確性確認
  - 日本語文字の正常表示確認

### 3. 補助機能テスト
#### 3.1 自動時間調整
- テストケース:
  - 指定時間内での自動調整確認
  - 合計時間の正確な計算確認

#### 3.2 RAG機能
- テストケース:
  - 類似度検索の精度確認
  - 類似度スコアの計算正確性確認
  - 機能切り替えの動作確認

## 非機能要件テスト
### 1. 性能テスト
- テスト項目:
  - 応答時間の計測（目標: 数秒〜数十秒以内）
  - 同時アクセス時の安定性確認
  - データ処理の効率性確認

### 2. セキュリティテスト
- テスト項目:
  - APIキーの安全な保存確認
  - アップロードデータの保護確認
  - アクセス制御の確認

## テスト実施手順
1. ユニットテスト
   - 各機能の個別テスト
   - エッジケースの確認

2. 統合テスト
   - 機能間の連携確認
   - データフローの確認

3. システムテスト
   - エンドツーエンドのシナリオテスト
   - 非機能要件の確認

4. 受入テスト
   - ユーザー視点での動作確認
   - 実際の利用シナリオに基づくテスト

## テスト環境
- 開発環境: Next.js / React / TypeScript
- ストレージ: Vercel KV / Vercel Blob
- 外部サービス: 各AI APIサービス
- ブラウザ: 主要ブラウザ（Chrome, Firefox, Safari, Edge）

## テストデータ
- サンプルPDF/CSVファイル
- テスト用APIキー
- モックデータ（練習メニュー）

## テスト結果記録
### 2025年4月14日
1. 単体テスト完了
   - テスト実施者: 開発チーム
   - 実施テスト項目:
     - AI メニュー生成関連: menu-validation.test.ts, menu-generation.test.ts
     - 機能テスト: search-and-display.test.ts, output-display.test.ts, search-similarity.test.ts
     - 補助機能テスト: time-calculations.test.ts
     - データ管理テスト: file-operations.test.ts, menu-management.test.ts, output-operations.test.ts
   - テストケース結果: すべてのテストが正常に完了
   - 発見された問題点: なし
   - 修正状況: 該当なし

2. 結合テスト（第1フェーズ）実施
   - テスト実施者: 開発チーム
   - 実施テストケース:
     - IT-001: メニュー生成と保存連携
     - IT-002: アップロードとRAG連携
     - IT-003: AIモデル切替と生成結果
     - IT-004: 検索と履歴表示連携
   - 発見された問題点:
     1. メニュー生成と保存連携
        - 関数シグネチャの不一致
        - 型定義の不整合
     2. アップロードとRAG連携
        - ファイル処理の引数順序の誤り
        - RAGコンテキストの受け渡し方法の改善が必要
     3. AIモデル切替
        - モックの設定パスが不適切
        - レスポンス形式の統一が必要
     4. 検索・履歴連携
        - 検索インターフェースの不整合
        - データ構造の変更への対応が不完全
   - 修正内容:
     1. setup.tsのモック設定を修正
     2. 型定義を正確に更新
     3. テストケースの期待値を調整
     4. 関数呼び出しの引数順序を修正
   - 修正状況: テストコードの修正は完了。実装との整合性確認が必要

   - 修正詳細（2025年4月14日追記）:
     1. **setup.tsの修正**
        - 重複していたCSVエンドポイントの定義を削除
        - 類似メニュー検索のレスポンス形式を `{ menus: [], similarities: [] }` 形式に統一
        - エラーメッセージを日本語化（「No file provided」→「ファイルが指定されていません」など）
        - API認証エラーのメッセージを「Invalid API key」から「無効なAPIキーです」に変更
        - メニュー生成時のデフォルトのメニュー項目を日本語化（「Warm Up」→「ウォームアップ」など）
        - NextResponse.jsonのモックを修正してステータスコードを設定できるように拡張
        - ルートハンドラのモックで無効なAPIキーの場合に401エラーを返すよう修正

     2. **menu-generation-storage.test.tsの修正**
        - ファイル先頭の不要な文字「ｐ」を削除
        - エラーメッセージの期待値を「無効なAPIキーです」に変更
        - 保存失敗テストの前にAPIキーを有効な値に戻す処理を追加

     3. **search-history-display.test.tsの修正**
        - 検索結果の型定義を新しいレスポンス形式に合わせて更新
        - 検索結果処理部分を修正（menuData → menus, similarityScore → similarities）
        - 型アサーションを使用して型エラーを解消

     4. **upload-rag.test.tsの修正**
        - generatedMenu.itemsをgeneratedMenu.menuに修正
        - RAG処理のエラーテストを修正（processForRAG → getEmbedding）

     すべての結合テストが正常に通過することを確認しました。

3. 結合テスト（第2フェーズ）実施
   - テスト実施者: 開発チーム
   - 実施テストケース:
     - IT-005: 生成と出力連携
     - IT-006: カスタマイズと時間調整連携
     - IT-007: 履歴と類似検索連携
     - IT-008: エラー処理の一貫性
   - 発見された問題点:
     1. 生成と出力連携: CSV出力のヘッダーに「強度」が含まれていなかった。
     2. カスタマイズと時間調整連携: モックのレスポンスがテスト内容と一致していなかった（loadLevels, specialNotesの検証）。
     3. 履歴と類似検索連携: OpenAIクライアントのブラウザ環境エラー、searchSimilarMenusモックのエラー。
   - 修正内容:
     1. lib/output-operations.tsのCSV生成ロジックを修正。
     2. customization-time-adjustment.test.tsの検証ロジックをモックに合わせて修正。
     3. setup.tsのsearchSimilarMenusモックを修正し、lib/embeddingのモックを追加。
   - 修正状況: すべてのテストがパス。

## 品質基準
- 重大なバグがないこと
- 応答時間が要件を満たすこと
- セキュリティ要件を満たすこと
- 日本語表示が正常であること
