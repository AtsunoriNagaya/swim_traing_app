---

# 水泳部向け練習メニュー作成アプリ 要件定義書

## 1. 概要
本ドキュメントは、水泳部のコーチや選手が効率的に練習メニューを作成するためのアプリケーション（以下、本アプリ）の要件を定義するものである。生成AIを活用し、過去のメニューデータを参照しながら、負荷や時間指定に基づいた最適な練習メニューの自動生成を目指す。

---

## 2. アプリの目的と背景

### 目的
- 練習メニュー作成にかかる時間と労力を削減する  
- 過去の練習実績（データ）を活用し、より効果的なメニューを作成する  
- 利用者のレベルや目的に合わせた多様なメニューを提供する  
- 生成AI技術を活用し、質の高いメニュー案を提示する  

### 背景
- 従来、練習メニュー作成は属人的なスキルや経験に依存しがちであった  
- 過去の膨大なメニューデータを有効活用できていないケースがある  
- 日々の練習目標（負荷、時間など）に応じて柔軟にメニューを調整したいというニーズがある  

---

## 3. 機能要件

| 機能ID | 機能名 | 機能概要 | 詳細 |
|--------|--------|----------|------|
| F-01 | 練習メニュー作成 | ユーザーの入力条件に基づいて、練習メニューを生成する | |
| F-01-01 | 自動メニュー生成 (AI) | 生成AIを用いて練習メニュー案を自動生成する | - 利用する生成AIモデルを以下から選択可:<br>  - OpenAI (gpt-4o)<br>  - Google (gemini-2.0-flash)<br>  - Anthropic (claude-3.5-sonnet)<br>- 各AIサービスのAPIキーはユーザーが入力する形式<br>- システムが適切なプロンプトを生成し、メニューを作成<br>- プロンプトには、負荷レベル、時間、RAGによる類似メニュー情報（時間ベース）、備考などを含む |
| F-01-02 | 負荷レベル選択 | 負荷レベルを指定してメニューを生成する | - A（高負荷）, B（中負荷）, C（低負荷）<br>- 複数選択可（例: A＋B） |
| F-01-03 | 時間指定 | 総時間に収まるメニューを生成する | - 分単位で時間指定可<br>- 各項目の所要時間と合計時間を計算・表示 |
| F-01-04 | 備考入力 | メニュー作成に関する要望や特記事項を入力 | - 自由記述欄を設置し、AIプロンプトに反映 |
| F-02 | 過去メニュー管理 | 過去のメニューを管理・活用する | |
| F-02-01 | アップロード機能 | メニューのCSV/PDFファイルをアップロード | - 内容を解析・保存 |
| F-02-02 | RAGによる参照 | 関連性の高い過去メニュー情報をAI生成に活用 | - **実装済み**<br>- Vercel KV/Blobに保存された過去メニューから、指定された時間 (duration) の±20%の範囲にあるメニューを検索 (`lib/kv-storage.ts` の `searchSimilarMenus` 関数)<br>- 検索結果（メニュータイトル、合計時間、対象スキル）をAIプロンプトに含め、参考情報として提供<br>- ベクトル検索は未実装（時間ベースのフィルタリングのみ）<br>- 該当データがない場合は参考情報なしで生成 |
| F-03 | メニュー出力 | 生成されたメニューを出力・ダウンロード | - PDF/CSVに対応<br>- 出力項目: 種目、距離、本数、サークル、休憩、所要時間、備考など |

---

## 4. 非機能要件

| 要件ID | 分類 | 要件内容 | 備考 |
|--------|------|----------|------|
| NF-01 | 使用技術 | バックエンド：Next.js API Routes (TypeScript v5)<br>フロントエンド：Next.js App Router (v15.2.4) + React (v19) | - App Router による最新のページルーティング<br>- サーバー/クライアントコンポーネントの適切な分離 |
| NF-02 | コスト | 無料/低コストなツールを優先 | - Vercel 無料枠活用 (KV, Blob含む)<br>- ユーザー自身のAPIキーを使用することで、サービス提供者側のAPIコスト負担なし |
| NF-03 | パフォーマンス | 応答時間は数秒〜数十秒以内 | RAG・生成AIの速度に配慮 |
| NF-04 | ユーザビリティ | 直感的UIを提供 | 水泳知識がなくても利用可能 |
| NF-05 | セキュリティ | 個人情報を含む場合の適切な管理 | アクセス制御等を検討 |
| NF-06 | 拡張性 | 将来的な機能追加に対応しやすく設計 | 例：選手ごとの進捗管理など |
| NF-07 | 保守性 | 高い可読性・再利用性のあるコード | メンテナンス容易性を確保 |

---

## 5. システム構成

- **フロントエンド & バックエンド**：Next.js (v15.2.4)
  - App Router によるページルーティング
  - API Routes によるサーバーサイド処理
  - TypeScript (v5) による型安全性の確保
  - React (v19)
  - Vercel でのホスティング

- **データベース**：
  - Vercel KV（インデックスファイルのURL）
  - Vercel Blob（メニューデータ本体、インデックスファイル）

- **AI連携**：
  - OpenAI API (gpt-4o)
  - Google Gemini API (gemini-2.0-flash)
  - Anthropic Claude API (claude-3.5-sonnet)
  - APIキーはユーザー提供方式

- **ドキュメント処理 (クライアントサイド)**：
  - PDF生成：jsPDF (v3.0.1) + jspdf-autotable (v5.0.2)
  - CSV生成：csv-stringify (v6.5.2)
  - ファイルアップロード：Next.js API Routes (実装詳細は未確認)

---

## 6. その他・考慮事項

- **プロンプトエンジニアリング**：
  - W-up, Kick, Pull, Drill, Main, Down などの構成を明示
  - 出力形式 (JSON) もプロンプトで指定
  - RAGによる過去メニューの参照機能（時間ベースのフィルタリング結果を挿入）

- **データ構造**：
  - 多様なCSV/PDFフォーマットから正確に練習情報を抽出できる柔軟なパーサーが必要
  - アップロードされたファイルの適切なバリデーション

- **所要時間計算ロジック**：
  - 各練習項目の距離・サークルタイム・休憩時間から現実的に算出
  - クライアントサイドでの即時計算

- **エラーハンドリング**：
  - ファイル不正、AI APIエラー等への対応とユーザーへの明確なフィードバックを実装
  - サーバーサイドレンダリングに関する問題への対処（`dynamic = 'force-dynamic'` など）
  - クライアント/サーバーコンポーネントの適切な分離による安定性確保
  - AI生成メニューの時間超過時の自動調整ロジック (`app/api/generate-menu/route.ts` 内)


---
